<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>%PAGE_TITLE%</title>
    <link rel="shortcut icon" type="image/png" href="/favicon.png" />
    <link rel="stylesheet" href="/style/style.css" />
    <script src="/js/menu.js"></script>
    <script src="/js/ws.js"></script>
    <script src="https://cdn.polyfill.io/v2/polyfill.min.js"></script>
    <script>
        var wsClient        = null; // Websocket client
        var logMessages     = [];
        var maxLogs         = 40;
        var isPageUnload    = false;

        function onClosed() {
            if (false === isPageUnload) {
                alert("Websocket connection closed.");
            }
        }

        function onEvent(evt) {
            var table = document.getElementById("output");
            var row = null;
            var cell = null;
            var index = 0;

            logMessages.push(evt);

            if (maxLogs < logMessages.length) {
                logMessages.shift();
                table.deleteRow(1);
            }

            row = table.insertRow(-1);
            cell = row.insertCell(-1);
            cell.innerHTML = evt.timestamp;
            cell = row.insertCell(-1);
            cell.innerHTML = pixelix.ws.getLogLevelStr(evt.level);
            cell = row.insertCell(-1);
            cell.innerHTML = evt.filename;
            cell = row.insertCell(-1);
            cell.innerHTML = evt.line;
            cell = row.insertCell(-1);
            cell.innerHTML = evt.text;
        }

        function toggleLog() {
            var bLog = document.getElementById("bLog");

            wsClient.setLog({
                enable: ("Enable" === bLog.value) ? true : false
            }).then(function(rsp) {

                if (false == rsp.isEnabled) {
                    bLog.value = "Enable";
                } else {
                    bLog.value = "Disable";
                }

            }).catch(function(err) {
                if ("undefined" !== typeof err) {
                    console.error(err);
                }
            });
        }

        function reset() {
            wsClient.reset().then(function(rsp) {
                alert("Ok.");
            }).catch(function(err) {
                alert("Error.");
            });
        }

        function startIperf() {
            wsClient.startIperf().then(function(rsp) {
                var bIperf = document.getElementById("bIperf");

                if (false == rsp.isEnabled) {
                    bIperf.value = "Enable";
                } else {
                    bIperf.value = "Disable";
                }

                alert("Ok.");
            }).catch(function(err) {
                alert("Error.");
            });
        }

        function stopIperf() {
            wsClient.stopIperf().then(function(rsp) {
                var bIperf = document.getElementById("bIperf");

                if (false == rsp.isEnabled) {
                    bIperf.value = "Enable";
                } else {
                    bIperf.value = "Disable";
                }

                alert("Ok.");
            }).catch(function(err) {
                alert("Error.");
            });
        }

        function toggleIperf() {
            var bIperf = document.getElementById("bIperf");

            if ("Enable" === bIperf.value) {
                startIperf();
            } else {
                stopIperf();
            }
        }

        window.onload = function() {

            injectMenu("navbar", window.location.pathname);

            wsClient = new pixelix.ws.Client();
            wsClient.connect({
                protocol: "%WS_PROTOCOL%",
                hostname: location.hostname,
                port: %WS_PORT%,
                endpoint: "%WS_ENDPOINT%",
                onClosed: onClosed,
                onEvent: onEvent
            }).then(function() {
                return wsClient.getLog();
            }).then(function(rsp) {
                var bLog = document.getElementById("bLog");

                if (false == rsp.isEnabled) {
                    bLog.value = "Enable";
                } else {
                    bLog.value = "Disable";
                }

                return wsClient.getIperf();
            }).then(function(rsp) {
                var bIperf = document.getElementById("bIperf");

                if (false == rsp.isEnabled) {
                    bIperf.value = "Enable";
                } else {
                    bIperf.value = "Disable";
                }
            }).catch(function(err) {
                if ("undefined" !== typeof err) {
                    console.error(err);
                }
            });
        };

        window.onbeforeunload = function() {
            isPageUnload = true;
            wsClient.disconnect();
        };
    </script>
</head>
<body>
<div class="header">
    %HEADER%
</div>
<div id="navbar" class="topnav">
</div>
<div class="main">
    <h2>Development</h2>
    <h3>System Reset</h3>
    <input type="button" value="Reset" onclick="reset();" />
    <h3>Performance Measurement</h3>
    <input id="bIperf" type="button" value="Enable" onclick="toggleIperf();" />
    <h3>Logging</h3>
    <input id="bLog" type="button" value="Enable" onclick="toggleLog();" />
    <p>Note, only the last 40 messages are show.</p>
    <div style="border: yellow 5px solid; padding: 10px">
        <font size="2" face="Courier New" >
            <table id="output" cellpadding="5px" style="white-space: pre-wrap;">
                <tr>
                    <th>Timestamp</th>
                    <th>Level</th>
                    <th>Filename</th>
                    <th>Line</th>
                    <th>Text</th>
                </tr>
            </table>
        </font>
    </div>
</div>
<div class="footer">
    <hr />
    <p>(C) 2019 - 2020 by Andreas Merkle (web@blue-andi.de)</p>
</div>
</body>
</html>