<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>%PAGE_TITLE%</title>
    <link rel="stylesheet" href="/data/style.css"></link>
    <script src="/data/ws.js"></script>
    <script>
        var matrixWidth     = 32;
        var matrixHeight    = 8;
        var ctx             = null;
        var pixelWidth      = 10;
        var pixelHeight     = 10;
        var intervalId      = 0;
        var wsClient        = null;

        function onClosed() {
            window.clearInterval(intervalId);
            return;
        }

        function plot(x, y, color) {
            if (null !== ctx) {
                ctx.lineWidth = "1";
                ctx.strokeStyle = color;
                ctx.fillStyle = color;
                ctx.fillRect(x * pixelWidth + x + 1, y * pixelHeight + y + 1, pixelWidth, pixelHeight);
            }
        }

        function getDisplayContent() {
            wsClient.getDisplayContent().then(function(rsp) {
                var x       = 0;
                var y       = 0;
                var index   = 0;
                var color   = 0;

                document.getElementById("slotId").innerHTML = "Slot: " + rsp.slotId;

                /* Handle display data */
                for(y = 0; y < matrixHeight; ++y) {
                    for(x = 0; x < matrixWidth; ++x) {
                        if (rsp.data.length > index) {
                            color   = parseInt(rsp.data[index]);
                            red     = (color & 0xff0000) >> 16;
                            green   = (color & 0x00ff00) >> 8;
                            blue    = (color & 0x0000ff) >> 0;
                            plot(x, y, "rgb(" + red + ", " + green + ", " + blue + ")");
                            ++index;
                        }
                    }
                }
            }).catch(function(err) {

            });

            return;
        }

        window.onload = function() {
            var displayCanvas = document.getElementById("canvas");

            ctx = displayCanvas.getContext("2d");

            wsClient = new pixelix.ws.Client();
            wsClient.connect({
                protocol: "%WS_PROTOCOL%",
                hostname: "%WS_HOSTNAME%",
                port: %WS_PORT%,
                endpoint: "%WS_ENDPOINT%",
                onClosed: onClosed,
            }).then(function(rsp) {
                return wsClient.getSlots();
            }).then(function(rsp) {
                var slots = "";
                var index = 0;

                slots += "<ul>\r\n";
                for(index = 0; index < rsp.slots.length; ++index) {
                    slots += "<li>"
                    slots += "Slot " + index + ": ";
                    if (0 == rsp.slots[index].length) {
                        slots += "-";
                    } else {
                        slots += rsp.slots[index].substring(1, rsp.slots[index].length - 1);
                    }
                    slots += "</li>\r\n"
                }
                slots += "</ul>\r\n";

                document.getElementById("slots").innerHTML = slots;
            }).then(function(rsp) {
                intervalId = window.setInterval(getDisplayContent, 400);
            }).catch(function(err) {

            });
        };
    </script>
</head>
<body>
<div class="header">
    %HEADER%
</div>
<div class="topnav">
    <a href="/">Home</a>
    <a href="/display" class="active">Display</a>
    <a href="/network">Network</a>
    <a href="/settings">Settings</a>
    <a href="/update">Update</a>
</div>
<div class="main">
    <h2>Display</h2>
    <p id="slotId">Slot: -</p>
    <canvas id="canvas" width="353" height="89" style="border: 1px solid #000000; background-color: black;"></canvas>
    <p>Installed plugins:</p>
    <p id="slots"></p>
</div>
<div class="footer">
    <hr />
    <p>(C) 2019 - 2020 by Andreas Merkle (web@blue-andi.de)</p>
</div>
</body>
</html>