<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>%PAGE_TITLE%</title>
    <link rel="stylesheet" href="/style/style.css" />
    <script src="/js/ws.js"></script>
    <script src="https://cdn.polyfill.io/v2/polyfill.min.js"></script>
    <script>
        var matrixWidth         = 32;   // LED matrix width in number of LEDs
        var matrixHeight        = 8;    // LED matrix height in number of LEDs
        var ctx                 = null; // Canvas context
        var pixelWidth          = 10;   // Width of a single LED in pixels
        var pixelHeight         = 10;   // Height of a single LED in pixels
        var timerId             = 0;    // Timer id
        var period              = 400;  // Display refresh period in ms
        var wsClient            = null; // Websocket client
        var plugins             = [];   // List of all available plugins
        var autoBrightnessCtrl  = false;// Is automatic brightness control enabled or disabled?
        var brightness          = 0;    // Brightness [0; 255]

        function onClosed() {
            window.clearTimeout(timerId);
            return;
        }

        function plot(x, y, color) {
            if (null !== ctx) {
                ctx.lineWidth = "1";
                ctx.strokeStyle = color;
                ctx.fillStyle = color;
                ctx.fillRect(x * pixelWidth + x + 1, y * pixelHeight + y + 1, pixelWidth, pixelHeight);
            }
        }

        function getDisplayContent() {
            wsClient.getDisplayContent().then(function(rsp) {
                var x       = 0;
                var y       = 0;
                var index   = 0;
                var color   = 0;

                document.getElementById("slotId").innerHTML = "Slot: " + rsp.slotId;

                /* Handle display data */
                for(y = 0; y < matrixHeight; ++y) {
                    for(x = 0; x < matrixWidth; ++x) {
                        if (rsp.data.length > index) {
                            color   = parseInt(rsp.data[index]);
                            red     = (color & 0xff0000) >> 16;
                            green   = (color & 0x00ff00) >> 8;
                            blue    = (color & 0x0000ff) >> 0;
                            plot(x, y, "rgb(" + red + ", " + green + ", " + blue + ")");
                            ++index;
                        }
                    }
                }
            }).catch(function(err) {
                if ("undefined" !== typeof err) {
                    console.error(err);
                }
            }).finally(function() {
                timerId = window.setTimeout(getDisplayContent, period);
            });

            return;
        }

        function install() {
            var element = document.getElementById("pluginToInstall");
            var pluginIndex = parseInt(element.options[element.selectedIndex].value);
            var pluginName = plugins[pluginIndex];

            return wsClient.install({
                pluginName: pluginName
            }).then(function(rsp) {
                return updateSlotInfo();
            }).catch(function(err) {
                if ("undefined" !== typeof err) {
                    console.error(err);
                }
                alert("Install " + pluginName + " failed.");
            });
        }

        function uninstall(slotId) {
            return wsClient.uninstall({
                slotId: slotId
            }).then(function(rsp) {
                return updateSlotInfo();
            }).catch(function(err) {
                if ("undefined" !== typeof err) {
                    console.error(err);
                }
                alert("Uninstall slot " + slotId + " failed.");
            });
        }

        function updateSlotInfo() {
            return wsClient.getSlots().then(function(rsp) {
                var element = document.getElementById("slots");
                var index = 0;
                var row = null;
                var cell = null;

                while(1 < element.rows.length) {
                    element.deleteRow(-1);
                }

                for(index = 0; index < rsp.slots.length; ++index) {
                    row = element.insertRow(-1);
                    cell = row.insertCell(-1);
                    cell.innerHTML = index;
                    cell = row.insertCell(-1);
                    if (0 === rsp.slots[index].name.length) {
                        cell.innerHTML = "-";
                    } else {
                        cell.innerHTML = rsp.slots[index].name;
                    }
                    cell = row.insertCell(-1);
                    if (0 === rsp.slots[index].name.length) {
                        cell.innerHTML = "-";
                    } else {
                        cell.innerHTML = rsp.slots[index].uid;
                    }
                    cell = row.insertCell(-1);
                    if (0 < rsp.slots[index].name.length) {
                        cell.innerHTML = "<input type=\"button\" value=\"Uninstall\" onclick=\"uninstall(" + index + ")\" />";
                    }
                }
            });
        }

        function updateBrightness() {
            document.getElementById("brightness").innerHTML = "" + (brightness * 100 / 255).toFixed(2) + " %%";
            document.getElementById("sliderBrightness").value = brightness;
        }

        function changeBrightness() {
            wsClient.setBrightness({
                brightness: parseInt(document.getElementById("sliderBrightness").value)
            }).then(function(rsp) {
                brightness = rsp.brightness;
                autoBrightnessCtrl = rsp.automaticBrightnessControl;
                updateAutoBrightnessCtrl();
                updateBrightness();
            }).catch(function(err) {
                if ("undefined" !== typeof err) {
                    console.error(err);
                }
                alert("Changing brightness failed.");
                updateBrightness();
            });
        }

        function updateAutoBrightnessCtrl() {
            if (false === autoBrightnessCtrl) {
                document.getElementById("autoBrightnessCtrl").innerHTML = "Disabled";
                document.getElementById("bAutoBrightnessCtrl").value = "Enable";
            } else {
                document.getElementById("autoBrightnessCtrl").innerHTML = "Enabled";
                document.getElementById("bAutoBrightnessCtrl").value = "Disable";
            }
        }

        function changeAutoBrightnessCtrl() {
            wsClient.setBrightness({
                brightness: brightness,
                automaticBrightnessControl: (false == autoBrightnessCtrl) ? true : false
            }).then(function(rsp) {
                brightness = rsp.brightness;
                autoBrightnessCtrl = rsp.automaticBrightnessControl;
                updateAutoBrightnessCtrl();
                updateBrightness();
            }).catch(function(err) {
                if ("undefined" !== typeof err) {
                    console.error(err);
                }
                alert("Changing automatic brightness control failed.");
            });
        }

        window.onload = function() {
            var displayCanvas = document.getElementById("canvas");

            ctx = displayCanvas.getContext("2d");

            wsClient = new pixelix.ws.Client();
            wsClient.connect({
                protocol: "%WS_PROTOCOL%",
                hostname: "%WS_HOSTNAME%",
                port: %WS_PORT%,
                endpoint: "%WS_ENDPOINT%",
                onClosed: onClosed,
            }).then(function(rsp) {
                return wsClient.getPlugins();
            }).then(function(rsp) {
                var element = document.getElementById("pluginToInstall");
                var option = null;
                var index = 0;

                plugins = rsp.plugins;

                for(index = 0; index < plugins.length; ++index) {
                    option = document.createElement("option");
                    option.value = index;
                    option.text = plugins[index];
                    element.add(option);
                }

                return updateSlotInfo();
            }).then(function(rsp) {
                return wsClient.getBrightness();
            }).then(function(rsp) {
                brightness = rsp.brightness;
                autoBrightnessCtrl = rsp.automaticBrightnessControl;
                updateAutoBrightnessCtrl();
                updateBrightness();
            }).then(function(rsp) {
                timerId = window.setTimeout(getDisplayContent, period);
            }).catch(function(err) {
                if ("undefined" !== typeof err) {
                    console.error(err);
                }
            });
        };
    </script>
</head>
<body>
<div class="header">
    %HEADER%
</div>
<div class="topnav">
    <a href="/">Home</a>
    <a href="/dev">Development</a>
    <a href="/display" class="active">Display</a>
    <a href="/edit">Filesystem</a>
    <a href="/network">Network</a>
    <a href="/settings">Settings</a>
    <a href="/update">Update</a>
</div>
<div class="main">
    <h2>Display</h2>
    <p id="slotId">Slot: -</p>
    <canvas id="canvas" width="353" height="89" style="border: 1px solid #000000; background-color: black;"></canvas>
    <p>
        <table id="slots">
            <tr>
                <th>Slot</th><th>Installed plugin</th><th>Plugin UID</th><th>Action</th>
            </tr>
        </table>
    </p>
    <p>
        <select id="pluginToInstall" size="1">
        </select>
        <br />
        <input type="button" value="Install" onclick="install()" />
    </p>
    <p>
        <table border="0">
            <tr>
                <td>Automatic brightness control:</td>
                <td id="autoBrightnessCtrl"></td>
                <td><input id="bAutoBrightnessCtrl" type="button" value="" onclick="changeAutoBrightnessCtrl()" /></td>
            </tr>
            <tr>
                <td>Brightness:</td>
                <td id="brightness"></td>
                <td>
                    <input type="range" id="sliderBrightness" min="0" max="255" onchange="changeBrightness()" />
                </td>
            </tr>
        </table>
    </p>
</div>
<div class="footer">
    <hr />
    <p>(C) 2019 - 2020 by Andreas Merkle (web@blue-andi.de)</p>
</div>
</body>
</html>