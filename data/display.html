<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>%PAGE_TITLE%</title>
    <link rel="shortcut icon" type="image/png" href="/favicon.png" />
    <link rel="stylesheet" href="/style/style.css" />
    <style>
        div.divSlot {
            height: 8em;
            width: 12em;
            border: 2px solid #666666;
            background-color: #ccc;
            margin-right: 5px;
            border-radius: 10px;
            box-shadow: inset 0 0 3px #000;
            text-align: center;
            float: left;
        }
        div.locked {
            background-image: repeating-linear-gradient(45deg, #ccc 0%%, #ccc 2%%, red 2%%, red 4%%, #ccc 4%%);
        }
        p.dragableSlot {
            border: 2px solid red;
            padding: 4px 4px 4px 4px;
            background-color: #666666;
            margin: 1em 1em 1em 1em;
            width: auto;
        }
        /* Prevent the text contents of draggable elements from being selectable. */
        [draggable] {
            -moz-user-select: none;
            -khtml-user-select: none;
            -webkit-user-select: none;
            user-select: none;
            cursor: move;
            /* Required to make elements draggable in old WebKit */
            -khtml-user-drag: element;
            -webkit-user-drag: element;
        }
        .divSlot header {
            color: #fff;
            background: red;
            text-shadow: #000 0 1px;
            padding: 5px;
            border-bottom: 1px solid #ddd;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
        }
    </style>
    <script src="/js/ws.js"></script>
    <script src="https://cdn.polyfill.io/v2/polyfill.min.js"></script>
    <script src="/js/dragDropTouch.js"></script>
    <script>
        var matrixWidth         = 32;   // LED matrix width in number of LEDs
        var matrixHeight        = 8;    // LED matrix height in number of LEDs
        var ctx                 = null; // Canvas context
        var pixelWidth          = 10;   // Width of a single LED in pixels
        var pixelHeight         = 10;   // Height of a single LED in pixels
        var timerId             = 0;    // Timer id
        var period              = 400;  // Display refresh period in ms
        var wsClient            = null; // Websocket client
        var plugins             = [];   // List of all available plugins
        var autoBrightnessCtrl  = false;// Is automatic brightness control enabled or disabled?
        var brightness          = 0;    // Brightness [0; 255]

        function onClosed() {
            window.clearTimeout(timerId);
            return;
        }

        function plot(x, y, color) {
            if (null !== ctx) {
                ctx.lineWidth = "1";
                ctx.strokeStyle = color;
                ctx.fillStyle = color;
                ctx.fillRect(x * pixelWidth + x + 1, y * pixelHeight + y + 1, pixelWidth, pixelHeight);
            }
        }

        function getDisplayContent() {
            wsClient.getDisplayContent().then(function(rsp) {
                var x       = 0;
                var y       = 0;
                var index   = 0;
                var color   = 0;

                document.getElementById("slotId").innerHTML = "Slot: " + rsp.slotId;

                /* Handle display data */
                for(y = 0; y < matrixHeight; ++y) {
                    for(x = 0; x < matrixWidth; ++x) {
                        if (rsp.data.length > index) {
                            color   = parseInt(rsp.data[index]);
                            red     = (color & 0xff0000) >> 16;
                            green   = (color & 0x00ff00) >> 8;
                            blue    = (color & 0x0000ff) >> 0;
                            plot(x, y, "rgb(" + red + ", " + green + ", " + blue + ")");
                            ++index;
                        }
                    }
                }
            }).catch(function(err) {
                if ("undefined" !== typeof err) {
                    console.error(err);
                }
            }).finally(function() {
                timerId = window.setTimeout(getDisplayContent, period);
            });

            return;
        }

        function install() {
            var element = document.getElementById("pluginToInstall");
            var pluginIndex = parseInt(element.options[element.selectedIndex].value);
            var pluginName = plugins[pluginIndex];

            return wsClient.install({
                pluginName: pluginName
            }).then(function(rsp) {
                return updateSlotInfo();
            }).catch(function(err) {
                if ("undefined" !== typeof err) {
                    console.error(err);
                }
                alert("Install " + pluginName + " failed.");
            });
        }

        function uninstall(slotId) {
            return wsClient.uninstall({
                slotId: slotId
            }).then(function(rsp) {
                return updateSlotInfo();
            }).catch(function(err) {
                if ("undefined" !== typeof err) {
                    console.error(err);
                }
                alert("Uninstall slot " + slotId + " failed.");
            });
        }

        function move(uid, slotId) {
            return wsClient.move({
                uid: uid,
                slotId: slotId
            }).then(function(rsp) {
            }).catch(function(err) {
                if ("undefined" !== typeof err) {
                    console.error(err);
                }
                alert("Moving failed.");
            }).finally(function() {
                return updateSlotInfo();
            });
        }

        function allowDrop(ev) {
            ev.preventDefault();
        }

        function drag(ev) {
            var src = document.getElementById(ev.target.id);
            src.style.opacity = "0.4";
            ev.dataTransfer.setData("src", ev.target.id);
        }

        function onDragEnd(ev) {
            var src = document.getElementById(ev.target.id);
            src.removeAttribute("style");
        }

        function drop(ev) {
            ev.preventDefault();
            var data = ev.dataTransfer.getData("src");
            var src = document.getElementById(data);
            var srcParent = src.parentNode;
            var dst = ev.currentTarget.lastElementChild;
            var dstParent = dst.parentNode;

            if ("uninstall" == dstParent.id) {
                uninstall(parseInt(srcParent.id));
            } else if (src.id != dst.id) {
                ev.currentTarget.replaceChild(src, dst);
                srcParent.appendChild(dst);

                move(parseInt(data), parseInt(dstParent.id));
            }
        }

        function setDuration(slotId) {
            var element = document.getElementById("duration" + slotId);
            var duration = parseInt(element.value) * 1000;
            return wsClient.setSlotDuration({
                slotId: slotId,
                duration: duration
            }).then(function(rsp) {
            }).catch(function(err) {
                if ("undefined" !== typeof err) {
                    console.error(err);
                }
                alert("Set duration failed.");
            }).finally(function() {
                return updateSlotInfo();
            });
        }

        function updateSlotInfo() {
            return wsClient.getSlots().then(function(rsp) {
                var element = document.getElementById("slots");
                var index = 0;
                var row = null;
                var cell = null;

                var divSlots = document.getElementById("divSlots");
                var divSlot = null;
                var dragableSlot = null;
                var htmlStr = "";

                divSlots.innerHTML = "";
                for(index = 0; index < rsp.slots.length; ++index) {
                    divSlot = document.createElement("div");

                    if (false == rsp.slots[index].isLocked) {
                        divSlot.setAttribute("class", "divSlot");
                        divSlot.setAttribute("ondragover", "allowDrop(event)");
                        divSlot.setAttribute("ondrop", "drop(event)");
                    } else {
                        divSlot.setAttribute("class", "divSlot locked");
                    }

                    divSlot.setAttribute("id", index);
                    htmlStr  = "<header>";
                    htmlStr += "Slot " + index + "<br />";
                    htmlStr += "<input id=\"duration" + index + "\" type=\"number\" value=\"" + (rsp.slots[index].duration / 1000) + "\" min=\"1\" max=\"3600000\" onchange=\"setDuration(" + index + ")\"/>"
                    htmlStr += "[s]";
                    htmlStr += "</header>";
                    divSlot.innerHTML = htmlStr;
                    divSlots.appendChild(divSlot);

                    dragableSlot = document.createElement("p");
                    dragableSlot.setAttribute("class", "dragableSlot");

                    if ((false == rsp.slots[index].isLocked) &&
                        (0 < rsp.slots[index].name.length)) {
                        dragableSlot.setAttribute("draggable", "true");
                        dragableSlot.setAttribute("ondragstart", "drag(event)");
                        dragableSlot.setAttribute("ondragend", "onDragEnd(event)");
                    }

                    if (0 == rsp.slots[index].name.length) {
                        dragableSlot.setAttribute("id", "A" + index);
                        dragableSlot.innerHTML = "-<br />UID -";
                    } else {
                        dragableSlot.setAttribute("id", rsp.slots[index].uid);
                        dragableSlot.innerHTML = rsp.slots[index].name + "<br />UID " + rsp.slots[index].uid;
                    }
                    divSlot.appendChild(dragableSlot);
                }

                divSlot = document.createElement("div");
                divSlot.setAttribute("class", "divSlot");
                divSlot.setAttribute("ondragover", "allowDrop(event)");
                divSlot.setAttribute("ondrop", "drop(event)");
                divSlot.setAttribute("id", "uninstall");
                divSlot.innerHTML = "<header>Uninstall</header>";
                divSlots.appendChild(divSlot);

                while(1 < element.rows.length) {
                    element.deleteRow(-1);
                }

                for(index = 0; index < rsp.slots.length; ++index) {
                    row = element.insertRow(-1);
                    cell = row.insertCell(-1);
                    cell.innerHTML = index;
                    cell = row.insertCell(-1);
                    if (0 === rsp.slots[index].name.length) {
                        cell.innerHTML = "-";
                    } else {
                        cell.innerHTML = rsp.slots[index].name;
                    }
                    cell = row.insertCell(-1);
                    if (0 === rsp.slots[index].name.length) {
                        cell.innerHTML = "-";
                    } else {
                        cell.innerHTML = rsp.slots[index].uid;
                    }
                    cell = row.insertCell(-1);
                    if (false === rsp.slots[index].isLocked) {
                        cell.innerHTML = "false";
                    } else {
                        cell.innerHTML = "true";
                    }
                    cell = row.insertCell(-1);
                    cell.innerHTML = rsp.slots[index].duration;
                    cell = row.insertCell(-1);
                    if (0 < rsp.slots[index].name.length) {
                        cell.innerHTML = "<input type=\"button\" value=\"Uninstall\" onclick=\"uninstall(" + index + ")\" />";
                    }
                }
            });
        }

        function updateBrightness() {
            document.getElementById("brightness").innerHTML = "" + (brightness * 100 / 255).toFixed(2) + " %%";
            document.getElementById("sliderBrightness").value = brightness;
        }

        function changeBrightness() {
            wsClient.setBrightness({
                brightness: parseInt(document.getElementById("sliderBrightness").value)
            }).then(function(rsp) {
                brightness = rsp.brightness;
                autoBrightnessCtrl = rsp.automaticBrightnessControl;
                updateAutoBrightnessCtrl();
                updateBrightness();
            }).catch(function(err) {
                if ("undefined" !== typeof err) {
                    console.error(err);
                }
                alert("Changing brightness failed.");
                updateBrightness();
            });
        }

        function updateAutoBrightnessCtrl() {
            if (false === autoBrightnessCtrl) {
                document.getElementById("autoBrightnessCtrl").innerHTML = "Disabled";
                document.getElementById("bAutoBrightnessCtrl").value = "Enable";
            } else {
                document.getElementById("autoBrightnessCtrl").innerHTML = "Enabled";
                document.getElementById("bAutoBrightnessCtrl").value = "Disable";
            }
        }

        function changeAutoBrightnessCtrl() {
            wsClient.setBrightness({
                brightness: brightness,
                automaticBrightnessControl: (false == autoBrightnessCtrl) ? true : false
            }).then(function(rsp) {
                brightness = rsp.brightness;
                autoBrightnessCtrl = rsp.automaticBrightnessControl;
                updateAutoBrightnessCtrl();
                updateBrightness();
            }).catch(function(err) {
                if ("undefined" !== typeof err) {
                    console.error(err);
                }
                alert("Changing automatic brightness control failed.");
            });
        }

        window.onload = function() {
            var displayCanvas = document.getElementById("canvas");

            ctx = displayCanvas.getContext("2d");

            wsClient = new pixelix.ws.Client();
            wsClient.connect({
                protocol: "%WS_PROTOCOL%",
                hostname: location.hostname,
                port: %WS_PORT%,
                endpoint: "%WS_ENDPOINT%",
                onClosed: onClosed,
            }).then(function(rsp) {
                return wsClient.getPlugins();
            }).then(function(rsp) {
                var element = document.getElementById("pluginToInstall");
                var option = null;
                var index = 0;

                plugins = rsp.plugins;

                for(index = 0; index < plugins.length; ++index) {
                    option = document.createElement("option");
                    option.value = index;
                    option.text = plugins[index];
                    element.add(option);
                }

                return updateSlotInfo();
            }).then(function(rsp) {
                return wsClient.getBrightness();
            }).then(function(rsp) {
                brightness = rsp.brightness;
                autoBrightnessCtrl = rsp.automaticBrightnessControl;
                updateAutoBrightnessCtrl();
                updateBrightness();
            }).then(function(rsp) {
                timerId = window.setTimeout(getDisplayContent, period);
            }).catch(function(err) {
                if ("undefined" !== typeof err) {
                    console.error(err);
                }
            });
        };

        window.onbeforeunload = function() {
            wsClient.disconnect();
        };
    </script>
</head>
<body>
<div class="header">
    %HEADER%
</div>
<div class="topnav">
    <a href="/">Home</a>
    <a href="/dev">Development</a>
    <a href="/display" class="active">Display</a>
    <a href="/edit">Filesystem</a>
    <a href="/network">Network</a>
    <a href="/settings">Settings</a>
    <a href="/update">Update</a>
</div>
<div class="main">
    <h2>Display</h2>
    <p id="slotId">Slot: -</p>
    <canvas id="canvas" width="353" height="89" style="border: 1px solid #000000; background-color: black;"></canvas>
    <p></p>
    <p>Note, you can move the plugins with drag'n drop to other slots.</p>
    <div id="divSlots">
    </div>
    <p style="clear: both;"><br /></p>
    <table id="slots">
        <tr>
            <th>Slot</th><th>Installed plugin</th><th>Plugin UID</th><th>Is locked?</th><th>Duration [ms]</th><th>Action</th>
        </tr>
    </table>
    <p></p>
    <p>
        <select id="pluginToInstall" size="1">
        </select>
        <br />
        <input type="button" value="Install" onclick="install()" />
    </p>
    <table border="0">
        <tr>
            <td>Automatic brightness control:</td>
            <td id="autoBrightnessCtrl"></td>
            <td><input id="bAutoBrightnessCtrl" type="button" value="" onclick="changeAutoBrightnessCtrl()" /></td>
        </tr>
        <tr>
            <td>Brightness:</td>
            <td id="brightness"></td>
            <td>
                <input type="range" id="sliderBrightness" min="0" max="255" onchange="changeBrightness()" />
            </td>
        </tr>
    </table>
</div>
<div class="footer">
    <hr />
    <p>(C) 2019 - 2020 by Andreas Merkle (web@blue-andi.de)</p>
</div>
</body>
</html>