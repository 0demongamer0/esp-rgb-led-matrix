<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>%PAGE_TITLE%</title>
    <link rel="stylesheet" href="/data/style.css"></link>
    <script src="/data/util.js"></script>
    <script>
        var matrixWidth     = 32;
        var matrixHeight    = 8;
        var ctx             = null;
        var pixelWidth      = 10;
        var pixelHeight     = 10;
        var intervalId      = 0;
        var webSocket       = null;
        
        function wsOpen(protocol, hostname, port, endpoint, onSuccess, onError, onClosed, onMessage) {
            var webSocketURL    = protocol + "://" + hostname + ":" + port + endpoint;
            var ws              = null;
            
            try {
                ws = new WebSocket(webSocketURL);
                
                ws.onopen = function(openEvent) {
                    console.debug("WebSocket OPEN: " + JSON.stringify(openEvent, null, 4));
                    if ("function" === typeof onSuccess) {
                        onSuccess();
                    }
                };
                
                ws.onclose = function(closeEvent) {
                    console.debug("WebSocket CLOSE: " + JSON.stringify(closeEvent, null, 4));
                    if ("function" === typeof onClosed) {
                        onClosed();
                    }
                };
                
                ws.onerror = function(errorEvent) {
                    console.debug("WebSocket ERROR: " + JSON.stringify(errorEvent, null, 4));
                    if ("function" === typeof onError) {
                        onError();
                    }
                };
                
                ws.onmessage = function(messageEvent) {
                    var wsMsg = messageEvent.data;
                    
                    console.debug("WebSocket MESSAGE: " + wsMsg);

                    if ("function" === typeof onMessage) {
                        onMessage(wsMsg);
                    }
                };
            } catch (exception) {
                console.error(exception);

                if ("function" === typeof onError) {
                    onError();
                }
            }

            return ws;
        }

        function onSuccess()
        {
            console.info("Websocket connected.");
            intervalId = window.setInterval(requestDisplayContent, 400);
            return;
        }

        function onError()
        {
            console.info("Websocket error.");
            return;
        }

        function onClosed()
        {
            console.info("Websocket disconnected.");
            window.clearInterval(intervalId);
            return;
        }

        function onMessage(msg)
        {
            var data    = msg.split(";");
            var status  = data.shift();
            var x       = 0;
            var y       = 0;
            var index   = 0;
            var color   = 0;

            if ("ACK" === status) {
                for(y = 0; y < matrixHeight; ++y) {
                    for(x = 0; x < matrixWidth; ++x) {
                        if (data.length > index) {
                            color   = parseInt(data[index]);
                            red     = (color & 0xff0000) >> 16;
                            green   = (color & 0x00ff00) >> 8;
                            blue    = (color & 0x0000ff) >> 0;
                            plot(x, y, "rgb(" + red + ", " + green + ", " + blue + ")");
                            ++index;
                        }
                    }
                }
            } else {
                console.error("ARGH!");
            }

            return;
        }

        function requestDisplayContent()
        {
            if (null !== webSocket) {
                webSocket.send("GETDISP");
            }

            return;
        }

        function plot(x, y, color) {
            if (null !== ctx) {
                ctx.lineWidth = "1";
                ctx.strokeStyle = color;
                ctx.fillStyle = color;
                ctx.fillRect(x * pixelWidth + x + 1, y * pixelHeight + y + 1, pixelWidth, pixelHeight);
            }
        }

        window.onload = function() {
            var displayCanvas = document.getElementById("canvas");
            
            ctx = displayCanvas.getContext("2d");

            webSocket = wsOpen("%WS_PROTOCOL%", "%WS_HOSTNAME%", "%WS_PORT%", "%WS_ENDPOINT%", onSuccess, onError, onClosed, onMessage);
        };
    </script>
</head>
<body>
<div class="header">
    %HEADER%
</div>
<div class="topnav">
    <a href="/">Home</a>
    <a href="/display" class="active">Display</a>
    <a href="/network">Network</a>
    <a href="/config">Configuration</a>
    <a href="/settings">Settings</a>
    <a href="/dev">Development</a>
    <a href="/update">Update</a>
</div>
<div class="main">
    <h2>Display</h2>
    <canvas id="canvas" width="353" height="89" style="border: 1px solid #000000; background-color: black;"></canvas>
</div>
<div class="footer">
    <hr />
    <p>(C) 2019 by Andreas Merkle (web@blue-andi.de)</p>
</div>
</body>
</html>